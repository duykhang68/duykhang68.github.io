<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>WTF</title>
    <meta name="description" content="My blog about Linux, Database, Infrastructure, some mathematics, and mindset.">

    <!-- todo: include this into main.css -->
    <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="https://blog.tracelog.in/wtf/">
    <link rel="alternate" type="application/rss+xml" title="Hieu's blog" href="https://blog.tracelog.in /feed.xml ">
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script async src="https://blog.tracelog.in/assets/dist/fetch.min.js"></script>
    <script>
    (function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
    })(document, window, 'https://analytics.tracelog.in/tracker.js', 'fathom');
    fathom('trackPageview');
    </script>
    <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
</head>

  <body>
    <div class="page-content">
      <div class="container">
        <div class="three columns">
          <header class="site-header">

  <h1 class="logo"><a href="https://blog.tracelog.in/archive">Blog</a></h2>

  <div class="nav">
    
    <label for="menu-toggle" class="menu-icon">
        <!--div data-icon="ei-navicon"></div-->
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
    </label>
    <input type="checkbox" id="menu-toggle">

    <div class="site-nav">
      <nav>
        <ul class="page-link">
          <li><a href="/">Home</a></li>
          <li><a href="/archive">Posts</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/photography">Photo</a></li>
          <li><a href="/friends">Friends</a></li>
          <li><a href="/hireme" style="color: #C25;font-size: 15px">Hire me ❯❯</a></span></li>
          <li><a href="/wtf" style="color: #FFD700;font-size: 15px">WTF❯❯</a></span></li>
        </ul>
      </nav>
    </div>

  </div>
</header>

        </div>

        <div class="nine columns" style="z-index:100;">
          <div class="wrapper">
            <article class="post">
  <header class="post-header">
    <h1 class="post-title">WTF</h1>
  </header>
  <div class="article-content">
     <p>Keyword: <a href="#1-mountfuck">Mountfuck</a>,
         <a href="#2-jenkinsfuck">Jenkinsfuck</a></p>

<h3 id="1-mountfuck">1. Mountfuck</h3>

<p><img src="/assets/img/wrong-mount-in-es.webp" alt="img" title="Entire fucking dir in fuckin /var/lib/elasticsearch" /></p>

<p><strong>Root cause:</strong></p>

<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>EBS uses single-root I/O virtualization (SR-IOV) to provide volume attachments on Nitro-based instances using the NVMe specification. 
These devices rely on standard NVMe drivers on the operating system. 
These drivers typically discover attached devices by scanning the PCI bus during instance boot, and create device nodes based on the order in which the devices respond, not on how the devices are specified in the block device mapping. 
In Linux, NVMe device names follow the pattern /dev/nvme&lt;x&gt;n&lt;y&gt;, where &lt;x&gt; is the enumeration order, and, for EBS, &lt;y&gt; is 1. 
Occasionally, devices can respond to discovery in a different order in subsequent instance starts, which causes the device name to change.
</code></pre>
</div>

<p>So, if we use NVMe disk for some new types of AWS EC2, please note that the device name is nearly randomize after each reboot.
It means if we have 2 NVMe disks on one EC2 vm, so we cannot know which device name delegate to which real disk.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>/dev/nvme1n1p1
/dev/nvme0n1p1
</code></pre>
</div>

<p><strong>Solution:</strong>
We must config fstab (permanent mount) based on UUID / label like this</p>
<div class="highlighter-rouge"><pre class="highlight"><code>LABEL=cloudimg-rootfs  /   ext4  defaults,discard  0 0
UUID="c46cf311-d31b-41ce-bce5-5d8ad0a6b109" /var/lib/elasticsearch ext4 defaults,nofail  0 2
</code></pre>
</div>

<p>DON’T config based on device name like this fuck</p>
<div class="highlighter-rouge"><pre class="highlight"><code>LABEL=cloudimg-rootfs	/	 ext4	defaults,discard	0 0
/dev/nvme1n1p1 /var/lib/elasticsearch ext4 defaults,nofail  0 2
</code></pre>
</div>

<h3 id="2-jenkinsfuck">2. Jenkinsfuck</h3>

<p><img src="/assets/img/jenkins-oops.webp" alt="img" title="EatWhatYouKill" /></p>
<div class="highlighter-rouge"><pre class="highlight"><code>Mar 01, 2019 11:19:14 AM org.eclipse.jetty.server.handler.ContextHandler$Context log
WARNING: Error while serving https://ci.tools.xxxxxx.io/job/live-xxxxxx/27/logText/progressiveHtml
java.lang.reflect.InvocationTargetException
    at org.kohsuke.stapler.Function$MethodFunction.invoke(Function.java:347)
    ...
    ...
    at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)
    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)
    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)
    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)
    at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)
    at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)
    ...
    ...
Caused by: java.lang.NegativeArraySizeException
    at hudson.console.ConsoleNote.readFrom(ConsoleNote.java:241)
    at hudson.console.ConsoleAnnotationOutputStream.eol(ConsoleAnnotationOutputStream.java:109)
    at hudson.console.LineTransformationOutputStream.eol(LineTransformationOutputStream.java:60)
</code></pre>
</div>

<p><strong>Root cause:</strong></p>

<p>Details of log: <a href="/assets/raw/jenkins-NegativeArraySizeException-error.log">jenkins-NegativeArraySizeException-error.log</a></p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NegativeArraySizeException</span>
<span class="kd">extends</span> <span class="n">RuntimeException</span>
</code></pre>
</div>

<p>Thrown if an application tries to create an array with negative size.</p>

<p>Output of this running job is: too big and spawn too fast <strong><code class="highlighter-rouge">rarely</code></strong> that reach <code class="highlighter-rouge">NegativeArraySize</code> during entire log workflow from</p>
<ul>
  <li>ConsoleNote &gt; ConsoleAnnotationOutputStream &gt; FileLogStorage &gt; ProxyOutputStream</li>
  <li>to doProgressText and until doProgressiveHtml</li>
</ul>

<p><strong>Solution:</strong> EatWhatYouKill</p>

<p>Don’t panic, just wait, let them come then let them go. Wait until this fucking job DONE. Then issuse will….gone</p>

  </div>
</article>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
